Instructions for installing on IOE-distributed local environments.

richards-mbp-3:~ alex$ ssh $dcms
Last login: Tue Jun 24 22:43:54 2014 from 192.168.99.1
[devadmin@dcms-developer ~]$ composer update
-bash: composer: command not found

# Install globally
Reference: https://getcomposer.org/doc/00-intro.md#globally

## PHP complains about allow_url_fopen

[devadmin@dcms-developer ~]$ curl -sS https://getcomposer.org/installer | php
#!/usr/bin/env php
Some settings on your machine make Composer unable to work properly.
Make sure that you fix the issues listed below and run this script again:

The allow_url_fopen setting is incorrect.
Add the following to the end of your `php.ini`:
    allow_url_fopen = On

The php.ini used by your command-line PHP is: /etc/php.ini
If you can not modify the ini file, you can also run `php -d option=value` to modify ini values on the fly. You can use -d multiple times.

## Fix PHP settings

### Go to http://www.reference.dcms-sa.local/admin/reports/status/php and retrieve current
### php.ini being used.

### Use/create a custom.ini

[devadmin@dcms-developer ~]$ sudo -s
[root@dcms-developer devadmin]# vim /etc/php.d/custom.ini

Put this in:

; Custom settings
allow_url_fopen = On

[root@dcms-developer devadmin]# exit


### Retry installation (requires root to move to /usr/local/bin/composer)

[devadmin@dcms-developer ~]$ curl -sS https://getcomposer.org/installer | php
#!/usr/bin/env php
All settings correct for using Composer
Downloading...

Composer successfully installed to: /home/devadmin/composer.phar
Use it: php composer.phar

mv composer.phar /usr/local/bin/composer


### Test as root

[root@dcms-developer devadmin]# composer --help
Usage:
 help [--xml] [--format="..."] [--raw] [command_name]

### Test as non-root

[root@dcms-developer devadmin]# exit
[devadmin@dcms-developer ~]$ composer --version
Composer version 28c65b5425f7f8722c260e3787b74c1ea6b37e3b 2014-06-22 18:24:28



## INSTALL COMPOSER DEPENDENCIES FOR BEHAT

### Assuming you're non-root.
### Assuming you have your home directory as a mounted share on the VM
### Assuming you checked out the DCMS Behat project to a directory called
"behat" to your home directory on the host machine (not the VM!):
### Replace "<alex>/behat" with your username, "behat" is your Git checkout location.

[devadmin@dcms-developer ~]$ ls
alex  dcms
[devadmin@dcms-developer ~]$ cd alex/behat/
[devadmin@dcms-developer behat]$ composer update
Loading composer repositories with package information
Updating dependencies (including require-dev)
...


## YOU WILL NEED A DRUSH ALIAS
### None is included at the moment with the DCMS environment
### You need the drush alias in the virtual machine, not on the host machine.

[devadmin@dcms-developer .drush]$ ls
cache
[devadmin@dcms-developer .drush]$ pwd
/home/devadmin/.drush

### Create an alias (on the virtual machine):
#### Assuming you have a "dcms" shared mount setup per IOE/DCMS instructions:

[devadmin@dcms-developer .drush]$ pwd
/home/devadmin/.drush

[devadmin@dcms-developer .drush]$ ls /home/devadmin/dcms/reference/site/
authorize.php       defaults.xml        INSTALL.mysql.txt   LICENSE.txt         PATCHES.txt         sites/              xmlrpc.php
build.xml           .gitignore          INSTALL.pgsql.txt   MAINTAINERS.txt     profiles/           themes/
CHANGELOG.txt       .htaccess           install.php         misc/               README.txt          update.php
COPYRIGHT.txt       includes/           INSTALL.sqlite.txt  modules/            robots.txt          UPGRADE.txt
cron.php            index.php           INSTALL.txt         patches/            scripts/            web.config

[devadmin@dcms-developer .drush]$ vim centos.aliases.drushrc.php

<?php

$aliases['ref.local'] = array(
  'uri' => 'www.reference.dcms-sa.local',
  'root' => '/home/devadmin/dcms/reference/site',
);

## REFRESH YOUR DRUSH CACHE AND VERIFY

[devadmin@dcms-developer .drush]$ cd ..
[devadmin@dcms-developer ~]$ drush cc drush
'drush' cache was cleared

[devadmin@dcms-developer ~]$ drush @ref.local status
 Drupal version                  :  7.26
 Site URI                        :  www.reference.dcms-sa.local
 Database driver                 :  mysql
 Database hostname               :  127.0.0.1
 Database username               :  devadmin
 Database name                   :  reference_local
 Database                        :  Connected
 Drupal bootstrap                :  Successful
 Drupal user                     :  Anonymous
 Default theme                   :  nexus
 Administration theme            :  ti_editorial
 PHP configuration               :  /data/timeinc/servers/fpm-dcms/conf/php/php.ini
 Drush version                   :  5.9
 Drush configuration             :
 Drush alias files               :  /home/devadmin/.drush/centos.aliases.drushrc.php
 Drupal root                     :  /home/devadmin/dcms/reference/site
 Site path                       :  sites/default
 File directory path             :  sites/default/files
 Temporary file directory path   :  /tmp

# FROM NOW ON YOU CAN USE YOUR NEWLY CREATED ALIAS ON YOUR BEHAT YAML FILE

Remember the alias: @ref.local

# Behat YAML profile information

Profile name: dcms-local
Configured alias:
  drush:
    alias: 'ref.local'

(Refer to behat.yml for more information)


# TEST NEW LOCAL DCMS PROFILE

[devadmin@dcms-developer behat]$ pwd
/home/devadmin/alex/behat
[devadmin@dcms-developer behat]$ bin/behat --profile dcms-local -dl
 Then /^Tell the browser to go back$/
 Then /^Tell the browser to go forward$/
Given /^Print the page title$/
Given /^Assert that JavaScript variable "([^"]*)" exists$/
Given /^the user role "([^"]*)"$/
Given /^The following environments:$/
 Then /^these variables must exist:$/
...

# MAKING BEHAT AVAILABLE GLOBALLY
## Assuming behat is checked out to the host machine, trying to link directly
to it will cause the virtual machine system to complain about too many symlink levels.
When doing a symlink to behat, use the shared mount path explicitely:

[root@dcms-developer bin]# ln -s /mnt/hgfs/alex/behat/bin/behat /usr/local/bin/behat

## Now you should be able to call behat from anywhere in the virtual machine.


# BEHAT/DRUPAL EXTENSION COMPLAINS ABOUT NOT FINDING YOUR DRUPAL SITE:

[devadmin@dcms-developer behat]$ behat --profile dcms-local



  [Symfony\Component\Config\Definition\Exception\InvalidConfigurationException]
  Unrecognized options "base_url" under "behat.extensions.drupal_drupalextension_extension"

## Fix:
### Verify your 'drupal_root' under 'Drupal\DrupalExtension\Extension' in your
behat.yml. Just to be safe, I opted to use a direct reference to the VMWare
mount:

...

    # Required by the behat Drupal Extension.
    Drupal\DrupalExtension\Extension:
      blackbox: ~
      api_driver: 'drupal'
      drupal:
        drupal_root: '/mnt/hgfs/alex/dcms/reference/site'
      drush:
        alias: 'ref.local'
...

### Refer to the behat.yml on this repository for reference.
### NOTICE: Unlike mentioned in http://dspeak.com/drupalextension/globalinstall.html#set-up-tests
### - there is no need to move your behat tooling (this repo) to the drupal
### core location. This allows you to use behat for any number of local installs,
### or even remote installs.



# How to call the dcms local test suite:

[devadmin@dcms-developer behat]$ behat --profile dcms-local



### HAPPY TESTING!!! ###



